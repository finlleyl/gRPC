# –°–µ—Ä–≤–∏—Å SSO –Ω–∞ gRPC

–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π **Single Sign‚ÄëOn (SSO)** –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ Go, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π gRPC‚ÄëAPI –¥–ª—è **—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –∏ **–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** —Å –≤—ã–¥–∞—á–µ–π –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö **JWT**‚Äë—Ç–æ–∫–µ–Ω–æ–≤.

<p align="center">
  <img src="https://user-images.githubusercontent.com/20046/273320805-a6d89aa8-e2c4-4024-9bce-c26d15ff7eed.png" width="520" alt="–î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã" />
</p>

---

## üìú –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
2. [–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π](#-—Å—Ç–µ–∫-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)

   * [–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
   * [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Protobuf](#–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-protobuf)
   * [–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π](#–∑–∞–ø—É—Å–∫-–º–∏–≥—Ä–∞—Ü–∏–π)
   * [–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞](#–∑–∞–ø—É—Å–∫-—Å–µ—Ä–≤–∏—Å–∞)
5. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
6. [gRPC¬†API](#-grpc-api)
7. [–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#-–ø—Ä–∏–º–µ—Ä-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
8. [–§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞](#-—Ñ–æ—Ä–º–∞—Ç-—Ç–æ–∫–µ–Ω–∞)
9. [–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#-—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
10. [–í–∫–ª–∞–¥](#-–≤–∫–ª–∞–¥)
11. [–õ–∏—Ü–µ–Ω–∑–∏—è](#-–ª–∏—Ü–µ–Ω–∑–∏—è)

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å          | –û–ø–∏—Å–∞–Ω–∏–µ                                                       |
| -------------------- | -------------------------------------------------------------- |
| **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**      | –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ *email* —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º        |
| **–í—Ö–æ–¥**             | –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –≤—ã–¥–∞—á–∞ JWT –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ **app\_id**  |
| **SQLite**‚Äë—Ö—Ä–∞–Ω–∏–ª–∏—â–µ | –õ—ë–≥–∫–∞—è —Ñ–∞–π–ª‚Äë–ë–î –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π                  |
| **–ú–∏–≥—Ä–∞—Ü–∏–∏**         | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–æ–π —á–µ—Ä–µ–∑ `golang-migrate`, CLI –≤ `cmd/migrator` |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT**    | HS256, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π TTL, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ + –∫–∞—Å—Ç–æ–º–Ω—ã–µ claims       |
| **–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ª–æ–≥–∏** | zap‚Äë–ª–æ–≥–≥–µ—Ä (dev/prod —Ä–µ–∂–∏–º—ã)                                   |
| **Taskfile**         | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ st—É–±–æ–≤ –∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á     |

---

## üîß –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

* **Go 1.24**
* **gRPC 1.60** –∏ **Protocol¬†Buffers¬†v3**
* **SQLite¬†3** (`github.com/mattn/go-sqlite3`)
* **golang-migrate** –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
* **zap** –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
* **bcrypt** –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π

---

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ cmd/            # –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (migrator –∏ gRPC‚Äë—Å–µ—Ä–≤–µ—Ä)
‚îú‚îÄ‚îÄ config/         # YAML‚Äë–∫–æ–Ω—Ñ–∏–≥–∏
‚îú‚îÄ‚îÄ internal/       # –î–æ–º–µ–Ω—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ app/        # DI –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ grpc/       # gRPC‚Äë–æ–±—ë—Ä—Ç–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ services/   # –ë–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ (auth)
‚îÇ   ‚îú‚îÄ‚îÄ storage/    # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (SQLite)
‚îÇ   ‚îî‚îÄ‚îÄ lib/        # –ü–∞–∫–µ—Ç—ã –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (jwt –∏ –¥—Ä.)
‚îú‚îÄ‚îÄ proto/          # .proto —Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ gen/            # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞–±—ã (–Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è)
‚îú‚îÄ‚îÄ migrations/     # SQL‚Äë–º–∏–≥—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ Taskfile.yaml   # Task‚Äë—Ä–∞–Ω–Ω–µ—Ä
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç                | –í–µ—Ä—Å–∏—è  | –ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å                                                    |
| ------------------------- | ------- | ----------------------------------------------------------------- |
| **Go**                    | ‚â• 1.24  | [https://go.dev/dl/](https://go.dev/dl/)                          |
| **protoc**                | ‚â• 3.21  | –ü–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏–ª–∏ release‚Äë–∞—Ä—Ö–∏–≤                               |
| **protoc-gen-go**         | latest  | `go install google.golang.org/protobuf/cmd/protoc-gen-go@latest`  |
| **protoc-gen-go-grpc**    | latest  | `go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest` |
| **Task** (–æ–ø—Ü.)           | ‚â• 3     | `go install github.com/go-task/task/v3/cmd/task@latest`           |
| **golang-migrate** (–æ–ø—Ü.) | ‚â• v4.16 | –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cmd/migrator`                        |

> **–ü–æ–¥—Å–∫–∞–∑–∫–∞:** `task check-tools` –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è Protobuf.

---

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Protobuf

```bash
# –°–∫—Ä–∏–ø—Ç (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ—Ç .proto –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç stubs –≤ gen/go)
$ task generate
```

–†—É—á–Ω–æ–π –≤—ã–∑–æ–≤:

```bash
protoc -I proto proto/sso/sso.proto \
  --go_out=gen/go --go_opt=paths=source_relative \
  --go-grpc_out=gen/go --go-grpc_opt=paths=source_relative
```

---

### –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –°–±–æ—Ä–∫–∞ —É—Ç–∏–ª–∏—Ç—ã
$ go build -o bin/migrator ./cmd/migrator

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–ë–î —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
$ ./bin/migrator \
  --storage-path=./storage/sso.db \
  --migrations-path=./migrations \
  --migrations-table=migrations
```

> –ü—É—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç *config/config\_local.yaml*.

---

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
# –°–±–æ—Ä–∫–∞ –±–∏–Ω–∞—Ä—è —Å–µ—Ä–≤–µ—Ä–∞
$ go build -o bin/sso ./cmd/sso

# –ó–∞–ø—É—Å–∫ —Å —è–≤–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º
$ ./bin/sso -config=config/config_local.yaml

# –ò–õ–ò —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
$ CONFIG_PATH=config/config_local.yaml ./bin/sso
```

–í –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è:

```
INFO	starting gRPC server on port	{"port":44044}
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ YAML‚Äë—Ñ–∞–π–ª–∞; –ø—É—Ç—å –∑–∞–¥–∞—ë—Ç—Å—è —Ñ–ª–∞–≥–æ–º `-config` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `CONFIG_PATH`.

```yaml
# config/config_local.yaml
env: "local"
storage_path: "./storage/sso.db"
grpc:
  port: 44044      # –ü–æ—Ä—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
  timeout: 10h     # –î–µ–¥–ª–∞–π–Ω –Ω–∞ –∑–∞–ø—Ä–æ—Å

token_ttl: 1h      # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ JWT
```

–î–ª—è prod‚Äë–æ–∫—Ä—É–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä `config/config_prod.yaml`).

---

## üõ∞Ô∏è gRPC¬†API

–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚îÄ [`proto/sso/sso.proto`](proto/sso/sso.proto):

```protobuf
service Auth {
  rpc Register (RegisterRequest) returns (RegisterResponse);
  rpc Login    (LoginRequest)    returns (LoginResponse);
}
```

| –ú–µ—Ç–æ–¥      | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞             | –û—Ç–≤–µ—Ç         |
| ---------- | ----------------------------- | ------------- |
| `Register` | `email`, `password`           | `user_id`     |
| `Login`    | `email`, `password`, `app_id` | `token` (JWT) |

> **–ö–æ–¥—ã –æ—à–∏–±–æ–∫** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç gRPC‚Äë—Å—Ç–∞–Ω–¥–∞—Ä—Ç—É. –í–∞–∂–Ω—ã–µ —Å–ª—É—á–∞–∏:
>
> * `InvalidArgument` ‚Äì –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã –ø–æ–ª—è
> * `AlreadyExists`  ‚Äì –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
> * `Internal`       ‚Äì –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

---

## üîå –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### grpcurl

```bash
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
grpcurl -plaintext -d '{"email":"bob@example.com","password":"s3cr3t"}' \
  localhost:44044 auth.Auth/Register

# –õ–æ–≥–∏–Ω
grpcurl -plaintext -d '{"email":"bob@example.com","password":"s3cr3t","app_id":1}' \
  localhost:44044 auth.Auth/Login
```

### Go‚Äë–∫–ª–∏–µ–Ω—Ç

```go
conn, _ := grpc.Dial("localhost:44044", grpc.WithInsecure())
client := ssopb.NewAuthClient(conn)

resp, err := client.Login(ctx, &ssopb.LoginRequest{
    Email:    "bob@example.com",
    Password: "s3cr3t",
    AppId:    1,
})
fmt.Println("JWT:", resp.Token)
```

---

## üîê –§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞

JWT –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º **HS256** —Å —Å–µ–∫—Ä–µ—Ç–æ–º, —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç–∞–±–ª–∏—Ü–∞ `apps`). –û—Å–Ω–æ–≤–Ω—ã–µ claim‚Äë—ã:

| Claim    | –¢–∏–ø    | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| -------- | ------ | ------------------------------------- |
| `uid`    | int64  | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                       |
| `email`  | string | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                    |
| `app_id` | int64  | ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∑–∞–ø—Ä–æ—Å–∏–≤—à–µ–≥–æ —Ç–æ–∫–µ–Ω     |
| `exp`    | int64  | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (`now` + `token_ttl`) |

---

## üóÑÔ∏è –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
CREATE TABLE IF NOT EXISTS users (
    id         INTEGER PRIMARY KEY,
    email      TEXT NOT NULL UNIQUE,
    pass_hash  BLOB NOT NULL
);

CREATE TABLE IF NOT EXISTS apps (
    id     INTEGER PRIMARY KEY,
    name   TEXT NOT NULL UNIQUE,
    secret TEXT NOT NULL UNIQUE
);
```

–ü—Ä–∏–º–µ—Ä –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:

```sql
INSERT INTO apps(name, secret) VALUES ('my-frontend', 'super-secret-key');
```

---
—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π **MIT**. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ `LICENSE`.
